# ================================
# All-in-one: Ollama + App
# ================================
FROM ollama/ollama:latest AS ollama-src
FROM python:3.10-slim AS base

# Tsinghua Source
ARG PIP_INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
ARG PIP_DEFAULT_TIMEOUT=120
ENV PIP_INDEX_URL=${PIP_INDEX_URL} \
    PIP_DEFAULT_TIMEOUT=${PIP_DEFAULT_TIMEOUT}

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    UV_LINK_MODE=copy \
    CONFIG_FILE=/app/conf/conf.yaml

WORKDIR /app

# Base dependencies
RUN apt-get update -o Acquire::Retries=5 \
 && apt-get install -y --no-install-recommends \
      ffmpeg git curl ca-certificates \
 && rm -rf /var/lib/apt/lists/*

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /usr/local/bin/

# Install Ollama
COPY --from=ollama/ollama:latest /bin/ollama /usr/local/bin/ollama

# Pre-install dependencies (leverage cache)
COPY pyproject.toml uv.lock ./
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev

# Copy source code and install project (without re-installing deps)
COPY . /app
RUN uv pip install --no-deps .

# Startup script
RUN printf '%s\n' \
  '#!/usr/bin/env sh' \
  'set -e' \
  '' \
  '# 0) Ensure unified mount dir exists' \
  'mkdir -p /app/conf' \
  '' \
  '# 1) Config: prefer user-provided /app/conf/conf.yaml; otherwise use template' \
  'if [ -f "/app/conf/conf.yaml" ]; then' \
  '  ln -sf /app/conf/conf.yaml /app/conf.yaml 2>/dev/null || cp -f /app/conf/conf.yaml /app/conf.yaml' \
  'elif [ ! -e "/app/conf.yaml" ] && [ -f "/app/config_templates/conf.yaml" ]; then' \
  '  cp /app/config_templates/conf.yaml /app/conf.yaml' \
  'fi' \
  '' \
  '# 1b) Link live2d-models, characters from /app/conf; otherwise use default' \
  'if [ -d "/app/conf/live2d-models" ]; then' \
  '  rm -rf /app/live2d-models && ln -s /app/conf/live2d-models /app/live2d-models' \
  'elif [ -d "/app/config_templates/live2d-models" ] && [ ! -e "/app/live2d-models" ]; then' \
  '  cp -r /app/config_templates/live2d-models /app/live2d-models' \
  'fi' \
  'if [ -d "/app/conf/characters" ]; then' \
  '  rm -rf /app/characters && ln -s /app/conf/characters /app/characters' \
  'elif [ -d "/app/config_templates/characters" ] && [ ! -e "/app/characters" ]; then' \
  '  cp -r /app/config_templates/characters /app/characters' \
  'fi' \
  '' \
  '# 2) Start Ollama (only visible inside container)' \
  'export OLLAMA_HOST="${OLLAMA_HOST:-127.0.0.1:11434}"' \
  'ollama serve & ' \
  '' \
  '# 3) Wait for Ollama to be ready (max 60s)' \
  'for i in $(seq 1 60); do' \
  '  if curl -fsS "http://127.0.0.1:11434/v1/models" >/dev/null 2>&1; then break; fi' \
  '  sleep 1' \
  'done' \
  '' \
  '# 4) Optional: pre-pull default model' \
  'if [ -n "${OLLAMA_DEFAULT_MODEL:-}" ]; then' \
  '  ollama list | grep -q "^${OLLAMA_DEFAULT_MODEL} " || ollama pull "$OLLAMA_DEFAULT_MODEL" || true' \
  'fi' \
  '' \
  '# 5) Start app (bind explicitly to 0.0.0.0:12393)' \
  'exec uv run run_server.py' \
  > /usr/local/bin/start-all && chmod +x /usr/local/bin/start-all

# Volumes: ollama cache, models, and unified config mount (conf.yaml + live2d-models + characters)
VOLUME ["/root/.ollama", "/app/models", "/app/conf"]

# âœ… Only expose the app port (Ollama is not exposed externally)
EXPOSE 12393

ARG OLLAMA_DEFAULT_MODEL=
ENV OLLAMA_DEFAULT_MODEL=${OLLAMA_DEFAULT_MODEL}

CMD ["/usr/local/bin/start-all"]