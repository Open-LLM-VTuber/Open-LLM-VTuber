# ================================
# App only (LLM managed externally)
# ================================

FROM python:3.10-slim

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    UV_LINK_MODE=copy \
    CONFIG_FILE=/app/conf/conf.yaml

WORKDIR /app

# ------------------------------------------------
# System deps
# ------------------------------------------------
RUN apt-get update -o Acquire::Retries=5 \
 && apt-get install -y --no-install-recommends \
      ffmpeg git curl ca-certificates \
 && rm -rf /var/lib/apt/lists/*

# ------------------------------------------------
# uv binary
# ------------------------------------------------
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /usr/local/bin/

# ------------------------------------------------
# Python deps (cached)
# ------------------------------------------------
COPY pyproject.toml uv.lock ./
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev

# ------------------------------------------------
# App code
# ------------------------------------------------
COPY . /app
RUN uv pip install --no-deps .

# ------------------------------------------------
# Entrypoint
# ------------------------------------------------
RUN cat > /usr/local/bin/start-app <<'EOF'
#!/usr/bin/env sh
set -eu

echo "[BOOT] Starting application container"

# ------------------------------------------------
# 0) Config check
# ------------------------------------------------
if [ ! -f "/app/conf/conf.yaml" ]; then
  echo "[ERROR] /app/conf/conf.yaml is required" >&2
  exit 1
fi

ln -sf /app/conf/conf.yaml /app/conf.yaml

# ------------------------------------------------
# 1) Resource directories (ONLY from conf)
# ------------------------------------------------
for d in live2d-models characters avatars backgrounds; do
  if [ -d "/app/conf/$d" ]; then
    rm -rf "/app/$d"
    ln -s "/app/conf/$d" "/app/$d"
    echo "[CONF] Linked $d"
  fi
done

# ------------------------------------------------
# 2) Read YAML config (NO side effects)
# ------------------------------------------------
command -v uv >/dev/null || {
  echo "[ERROR] uv not found in runtime environment"
  exit 1
}

eval "$(
uv run - <<'PY'
import yaml

with open("/app/conf/conf.yaml", "r") as f:
    cfg = yaml.safe_load(f) or {}

agent_cfg = cfg.get("character_config", {}).get("agent_config", {})
provider = agent_cfg.get("agent_settings", {}) \
                    .get("basic_memory_agent", {}) \
                    .get("llm_provider", "")

llm_cfg = agent_cfg.get("llm_configs", {}).get(provider, {})
base_url = llm_cfg.get("base_url", "")

print(f'LLM_PROVIDER="{provider}"')
print(f'LLM_BASE_URL="{base_url}"')
PY
)"

echo "[CONF] LLM_PROVIDER=$LLM_PROVIDER"

# ------------------------------------------------
# 3) Sanity check (README compliant)
# ------------------------------------------------
if [ "$LLM_PROVIDER" = "ollama_llm" ]; then
  echo "[INFO] Using ollama_llm"
  echo "[INFO] Expecting Ollama to be running externally"
elif [ "$LLM_PROVIDER" = "openai_compatible_llm" ]; then
  echo "[INFO] Using openai_compatible_llm"
else
  echo "[INFO] Using LLM provider: $LLM_PROVIDER"
fi

# ------------------------------------------------
# 4) Start app
# ------------------------------------------------
echo "[BOOT] Launching server"
exec uv run run_server.py
EOF

RUN sed -i 's/\r$//' /usr/local/bin/start-app \
 && chmod +x /usr/local/bin/start-app

# ------------------------------------------------
# Volumes (config only)
# ------------------------------------------------
VOLUME ["/app/conf"]

EXPOSE 12393

CMD ["/usr/local/bin/start-app"]
